{% extends "base.html" %}

{% block title %}Recipe Generator - Smart Grocery + Recipe Planner{% endblock %}

{% block content %}
<div class="recipe-generator-bg" style="margin: 0; padding: 2rem 0;">
    <div class="container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-white floating">
                <i class="fas fa-utensils me-3"></i>
                AI Recipe Generator
            </h1>
            <p class="lead text-white opacity-75">Generate personalized recipes based on your ingredients and preferences</p>
        </div>
        
        <div class="main-content">
            <div class="row g-4">
                <!-- Recipe Input Panel -->
                <div class="col-lg-6">
                    <div class="card glass">
                        <div class="card-header">
                            <h5><i class="fas fa-list-ul me-2"></i>Recipe Preferences</h5>
                        </div>
                        <div class="card-body">
                            <form id="recipe-form">
                                <!-- Available Ingredients -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-apple-alt me-2 text-success"></i>Available Ingredients
                                    </label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="ingredient_input" 
                                               placeholder="Type ingredient and press Enter">
                                        <button class="btn btn-outline-success" type="button" onclick="addIngredient()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="ingredients_list" class="d-flex flex-wrap gap-2">
                                        <!-- Ingredients will be added here -->
                                    </div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillDemoIngredients()">
                                            <i class="fas fa-magic me-1"></i>Use Demo Ingredients
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Cuisine Type -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-globe me-2 text-primary"></i>Cuisine Type
                                    </label>
                                    <select class="form-select" id="cuisine_type">
                                        <option value="">Any Cuisine</option>
                                        <option value="italian">Italian</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="indian">Indian</option>
                                        <option value="mexican">Mexican</option>
                                        <option value="american">American</option>
                                        <option value="french">French</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="mediterranean">Mediterranean</option>
                                        <option value="thai">Thai</option>
                                        <option value="korean">Korean</option>
                                    </select>
                                </div>
                                
                                <!-- Meal Type -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-clock me-2 text-warning"></i>Meal Type
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="meal_type" id="breakfast" value="breakfast">
                                                <label class="form-check-label" for="breakfast">Breakfast</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="meal_type" id="lunch" value="lunch" checked>
                                                <label class="form-check-label" for="lunch">Lunch</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="meal_type" id="dinner" value="dinner">
                                                <label class="form-check-label" for="dinner">Dinner</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="meal_type" id="snack" value="snack">
                                                <label class="form-check-label" for="snack">Snack</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dietary Restrictions -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-leaf me-2 text-info"></i>Dietary Restrictions
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="vegetarian" id="veg">
                                                <label class="form-check-label" for="veg">Vegetarian</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="vegan" id="vegan_recipe">
                                                <label class="form-check-label" for="vegan_recipe">Vegan</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="gluten_free" id="gluten_free_recipe">
                                                <label class="form-check-label" for="gluten_free_recipe">Gluten-Free</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="dairy_free" id="dairy_free_recipe">
                                                <label class="form-check-label" for="dairy_free_recipe">Dairy-Free</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="keto" id="keto">
                                                <label class="form-check-label" for="keto">Keto</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="low_carb" id="low_carb">
                                                <label class="form-check-label" for="low_carb">Low-Carb</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cooking Time -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-stopwatch me-2 text-danger"></i>Cooking Time
                                    </label>
                                    <select class="form-select" id="cooking_time">
                                        <option value="">No Preference</option>
                                        <option value="quick">Quick (< 30 min)</option>
                                        <option value="medium">Medium (30-60 min)</option>
                                        <option value="long">Long (> 60 min)</option>
                                    </select>
                                </div>
                                
                                <!-- Serving Size -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-users me-2 text-purple"></i>Serving Size
                                    </label>
                                    <input type="number" class="form-control" id="servings" 
                                           placeholder="Number of servings" min="1" max="12" value="4">
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-success me-2" onclick="generateRecipe()">
                                        <i class="fas fa-magic me-2"></i>Generate Recipe
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="surpriseMe()">
                                        <i class="fas fa-random me-2"></i>Surprise Me!
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Recipe Display Panel -->
                <div class="col-lg-6">
                    <div class="card glass">
                        <div class="card-header">
                            <h5><i class="fas fa-book-open me-2"></i>Generated Recipe</h5>
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-light" id="save_recipe" onclick="saveRecipe()" style="display: none;">
                                    <i class="fas fa-heart me-1"></i>Save
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="recipe_display">
                                <div class="text-center py-5">
                                    <i class="fas fa-utensils text-muted floating" style="font-size: 4rem;"></i>
                                    <h5 class="mt-3 text-muted">Ready to Cook?</h5>
                                    <p class="text-muted">Add your ingredients and generate a delicious recipe!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nutrition Information -->
                    <div class="card glass mt-4" id="nutrition_card" style="display: none;">
                        <div class="card-header">
                            <h5><i class="fas fa-heartbeat me-2"></i>Nutrition Information</h5>
                        </div>
                        <div class="card-body">
                            <div id="nutrition_info">
                                <!-- Nutrition data will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Saved Recipes -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card glass">
                        <div class="card-header">
                            <h5><i class="fas fa-bookmark me-2"></i>Saved Recipes</h5>
                            <button class="btn btn-sm btn-outline-light float-end" onclick="clearSavedRecipes()">
                                <i class="fas fa-trash me-1"></i>Clear All
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="saved_recipes">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-bookmark" style="font-size: 2rem;"></i>
                                    <p class="mt-2">No saved recipes yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentIngredients = [];
    let savedRecipes = JSON.parse(localStorage.getItem('savedRecipes') || '[]');
    let currentRecipe = null;
    
    function addIngredient() {
        const input = document.getElementById('ingredient_input');
        const ingredient = input.value.trim();
        
        if (ingredient && !currentIngredients.includes(ingredient.toLowerCase())) {
            currentIngredients.push(ingredient.toLowerCase());
            updateIngredientsDisplay();
            input.value = '';
        }
    }
    
    function removeIngredient(ingredient) {
        const index = currentIngredients.indexOf(ingredient);
        if (index > -1) {
            currentIngredients.splice(index, 1);
            updateIngredientsDisplay();
        }
    }
    
    function updateIngredientsDisplay() {
        const container = document.getElementById('ingredients_list');
        
        if (currentIngredients.length === 0) {
            container.innerHTML = '<small class="text-muted">No ingredients added yet</small>';
            return;
        }
        
        const ingredientsHtml = currentIngredients.map(ingredient => `
            <span class="badge bg-success-subtle text-success-emphasis p-2">
                ${ingredient}
                <button type="button" class="btn-close btn-close-white ms-2" 
                        onclick="removeIngredient('${ingredient}')" style="font-size: 0.7rem;"></button>
            </span>
        `).join('');
        
        container.innerHTML = ingredientsHtml;
    }
    
    function fillDemoIngredients() {
        currentIngredients = ['chicken breast', 'tomatoes', 'onion', 'garlic', 'rice', 'olive oil', 'herbs'];
        updateIngredientsDisplay();
        showAlert('Demo ingredients added!', 'info');
    }
    
    async function generateRecipe() {
        if (currentIngredients.length === 0) {
            showAlert('Please add at least one ingredient', 'warning');
            return;
        }
        
        const recipeData = {
            ingredients: currentIngredients,
            cuisine_type: document.getElementById('cuisine_type').value,
            meal_type: document.querySelector('input[name="meal_type"]:checked').value,
            dietary_restrictions: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value),
            cooking_time: document.getElementById('cooking_time').value,
            servings: parseInt(document.getElementById('servings').value) || 4
        };
        
        showRecipeLoading();
        
        try {
            const response = await makeAPICall('/api/generate-recipe', recipeData, 'POST');
            
            if (response.status === 'success') {
                currentRecipe = response.recipe;
                displayRecipe(response.recipe);
                generateNutritionInfo(response.recipe);
                document.getElementById('save_recipe').style.display = 'inline-block';
                showAlert('Recipe generated successfully!', 'success');
            } else {
                throw new Error(response.message || 'Failed to generate recipe');
            }
        } catch (error) {
            showAlert('Error generating recipe: ' + error.message, 'danger');
            displayFallbackRecipe(recipeData);
        }
    }
    
    function surpriseMe() {
        // Generate random recipe parameters
        const cuisines = ['italian', 'chinese', 'indian', 'mexican', 'american', 'french', 'japanese', 'mediterranean'];
        const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
        const randomIngredients = ['chicken', 'beef', 'fish', 'vegetables', 'pasta', 'rice', 'potatoes', 'eggs'];
        
        // Set random values
        document.getElementById('cuisine_type').value = cuisines[Math.floor(Math.random() * cuisines.length)];
        document.querySelector(`input[value="${mealTypes[Math.floor(Math.random() * mealTypes.length)]}"]`).checked = true;
        
        // Add random ingredients
        currentIngredients = [];
        for (let i = 0; i < 5; i++) {
            const ingredient = randomIngredients[Math.floor(Math.random() * randomIngredients.length)];
            if (!currentIngredients.includes(ingredient)) {
                currentIngredients.push(ingredient);
            }
        }
        updateIngredientsDisplay();
        
        // Generate recipe
        setTimeout(() => {
            generateRecipe();
        }, 500);
        
        showAlert('Surprise recipe coming up!', 'info');
    }
    
    function showRecipeLoading() {
        document.getElementById('recipe_display').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3">Generating your recipe...</h5>
                <p class="text-muted">AI is cooking up something delicious!</p>
            </div>
        `;
    }
    
    function displayRecipe(recipe) {
        const recipeHtml = `
            <div class="recipe-content">
                <div class="text-center mb-4">
                    <h3 class="text-primary">${recipe.name}</h3>
                    <div class="d-flex justify-content-center gap-3 mt-3">
                        <span class="badge bg-info-subtle text-info-emphasis p-2">
                            <i class="fas fa-clock me-1"></i>${recipe.prep_time}
                        </span>
                        <span class="badge bg-warning-subtle text-warning-emphasis p-2">
                            <i class="fas fa-users me-1"></i>${recipe.servings} servings
                        </span>
                        <span class="badge bg-success-subtle text-success-emphasis p-2">
                            <i class="fas fa-fire me-1"></i>${recipe.calories} cal
                        </span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5><i class="fas fa-list me-2 text-primary"></i>Ingredients</h5>
                    <ul class="list-group list-group-flush">
                        ${recipe.ingredients.map(ingredient => `
                            <li class="list-group-item bg-transparent">${ingredient}</li>
                        `).join('')}
                    </ul>
                </div>
                
                <div class="mb-4">
                    <h5><i class="fas fa-clipboard-list me-2 text-success"></i>Instructions</h5>
                    <ol class="list-group list-group-numbered">
                        ${recipe.instructions.map(instruction => `
                            <li class="list-group-item bg-transparent">${instruction}</li>
                        `).join('')}
                    </ol>
                </div>
                
                ${recipe.tips ? `
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Chef's Tips:</strong> ${recipe.tips}
                    </div>
                ` : ''}
            </div>
        `;
        
        document.getElementById('recipe_display').innerHTML = recipeHtml;
    }
    
    function displayFallbackRecipe(recipeData) {
        const fallbackRecipe = {
            name: `${recipeData.cuisine_type || 'Delicious'} ${recipeData.meal_type || 'Dish'}`.replace(/^\w/, c => c.toUpperCase()),
            prep_time: '30-45 minutes',
            servings: recipeData.servings,
            calories: 400,
            ingredients: [
                ...recipeData.ingredients.map(ing => `1 portion ${ing}`),
                'Salt and pepper to taste',
                'Cooking oil as needed'
            ],
            instructions: [
                'Prep all ingredients by washing and chopping as needed.',
                'Heat oil in a large pan over medium heat.',
                'Add ingredients starting with those that take longest to cook.',
                'Season with salt and pepper.',
                'Cook until all ingredients are tender and flavors are well combined.',
                'Serve hot and enjoy!'
            ],
            tips: 'Taste and adjust seasonings as needed. Feel free to add your favorite herbs and spices!'
        };
        
        currentRecipe = fallbackRecipe;
        displayRecipe(fallbackRecipe);
        generateNutritionInfo(fallbackRecipe);
        document.getElementById('save_recipe').style.display = 'inline-block';
    }
    
    function generateNutritionInfo(recipe) {
        // Simulate nutrition calculation
        const nutrition = {
            calories: recipe.calories || 400,
            protein: Math.round(recipe.calories * 0.15 / 4) || 15,
            carbs: Math.round(recipe.calories * 0.55 / 4) || 55,
            fat: Math.round(recipe.calories * 0.30 / 9) || 13,
            fiber: Math.round(Math.random() * 10 + 5),
            sodium: Math.round(Math.random() * 800 + 200)
        };
        
        const nutritionHtml = `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card border-0 glass">
                        <div class="card-body text-center">
                            <h4 class="text-primary">${nutrition.calories}</h4>
                            <small>Calories</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 glass">
                        <div class="card-body text-center">
                            <h4 class="text-success">${nutrition.protein}g</h4>
                            <small>Protein</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 glass">
                        <div class="card-body text-center">
                            <h4 class="text-warning">${nutrition.carbs}g</h4>
                            <small>Carbs</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 glass">
                        <div class="card-body text-center">
                            <h4 class="text-info">${nutrition.fat}g</h4>
                            <small>Fat</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Fiber: ${nutrition.fiber}g | Sodium: ${nutrition.sodium}mg
                </small>
            </div>
        `;
        
        document.getElementById('nutrition_info').innerHTML = nutritionHtml;
        document.getElementById('nutrition_card').style.display = 'block';
    }
    
    function saveRecipe() {
        if (!currentRecipe) return;
        
        const recipeToSave = {
            ...currentRecipe,
            id: Date.now(),
            saved_date: new Date().toLocaleDateString()
        };
        
        savedRecipes.unshift(recipeToSave);
        localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
        
        displaySavedRecipes();
        showAlert('Recipe saved successfully!', 'success');
    }
    
    function displaySavedRecipes() {
        const container = document.getElementById('saved_recipes');
        
        if (savedRecipes.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-bookmark" style="font-size: 2rem;"></i>
                    <p class="mt-2">No saved recipes yet</p>
                </div>
            `;
            return;
        }
        
        const recipesHtml = savedRecipes.map(recipe => `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card glass h-100">
                    <div class="card-body">
                        <h6 class="card-title">${recipe.name}</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${recipe.prep_time} | 
                                <i class="fas fa-users me-1"></i>${recipe.servings} servings
                            </small>
                        </p>
                        <p class="card-text">
                            <small class="text-muted">Saved: ${recipe.saved_date}</small>
                        </p>
                        <div class="btn-group w-100">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecipe(${recipe.id})">
                                <i class="fas fa-eye me-1"></i>View
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecipe(${recipe.id})">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `<div class="row">${recipesHtml}</div>`;
    }
    
    function loadRecipe(recipeId) {
        const recipe = savedRecipes.find(r => r.id === recipeId);
        if (recipe) {
            currentRecipe = recipe;
            displayRecipe(recipe);
            generateNutritionInfo(recipe);
            document.getElementById('save_recipe').style.display = 'none';
        }
    }
    
    function deleteRecipe(recipeId) {
        savedRecipes = savedRecipes.filter(r => r.id !== recipeId);
        localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
        displaySavedRecipes();
        showAlert('Recipe deleted', 'info');
    }
    
    function clearSavedRecipes() {
        if (confirm('Are you sure you want to delete all saved recipes?')) {
            savedRecipes = [];
            localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
            displaySavedRecipes();
            showAlert('All recipes cleared', 'info');
        }
    }
    
    // Handle Enter key for ingredient input
    document.getElementById('ingredient_input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addIngredient();
        }
    });
    
    // Load saved recipes on page load
    document.addEventListener('DOMContentLoaded', function() {
        displaySavedRecipes();
    });
</script>
{% endblock %}
