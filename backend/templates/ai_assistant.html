{% extends "base.html" %}

{% block title %}AI Assistant - Smart Grocery + Recipe Planner{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="text-center">
                <h1 class="display-4 fw-bold text-primary mb-3">ðŸ¤– AI Nutritionist Assistant</h1>
                <p class="lead text-muted">Get personalized nutrition advice, cooking tips, and meal planning guidance from our AI-powered assistant</p>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="card-header text-white" style="background: var(--gradient-primary); border-radius: var(--border-radius) var(--border-radius) 0 0;">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-robot text-primary"></i>
                            </div>
                        </div>
                        <div>
                            <h5 class="mb-0">AI Nutritionist</h5>
                            <small class="opacity-75">Online and ready to help</small>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-success">
                                <i class="fas fa-circle me-1" style="font-size: 8px;"></i>Online
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Chat Messages Area -->
                    <div id="chat-messages" class="chat-container" style="height: 400px; overflow-y: auto; padding: 20px;">
                        <div class="message-bubble ai-message">
                            <div class="d-flex mb-3">
                                <div class="me-3">
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="fas fa-robot text-primary" style="font-size: 14px;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="message-content">
                                        <p class="mb-0">Hello! I'm your AI Nutritionist Assistant. I can help you with:</p>
                                        <ul class="mb-0 mt-2">
                                            <li>Personalized nutrition advice</li>
                                            <li>Healthy recipe suggestions</li>
                                            <li>Meal planning guidance</li>
                                            <li>Dietary questions and concerns</li>
                                            <li>Cooking tips and techniques</li>
                                        </ul>
                                        <p class="mb-0 mt-2">What would you like to know about nutrition and healthy eating?</p>
                                    </div>
                                    <small class="timestamp">Just now</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-light">
                    <!-- Chat Input -->
                    <div class="row g-3">
                        <div class="col">
                            <div class="input-group">
                                <input type="text" id="user-message" class="form-control" placeholder="Ask me anything about nutrition, recipes, or meal planning..." maxlength="500">
                                <button class="btn btn-primary" type="button" id="send-message" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane me-2"></i>Send
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Questions -->
                    <div class="mt-3">
                        <small class="text-muted d-block mb-2">Quick questions:</small>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuickQuestion('What are some healthy breakfast ideas?')">
                                Healthy breakfast ideas
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuickQuestion('How to meal prep for the week?')">
                                Meal prep tips
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuickQuestion('What are good protein sources?')">
                                Protein sources
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="askQuickQuestion('How to eat more vegetables?')">
                                More vegetables
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-5">
        <div class="col">
            <div class="text-center mb-4">
                <h3 class="fw-bold">What I Can Help You With</h3>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="glass-card h-100 text-center">
                        <div class="card-body">
                            <div class="text-primary mb-3">
                                <i class="fas fa-apple-alt fa-3x"></i>
                            </div>
                            <h5>Nutrition Guidance</h5>
                            <p class="text-muted">Get personalized advice on macronutrients, vitamins, and healthy eating habits.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card h-100 text-center">
                        <div class="card-body">
                            <div class="text-success mb-3">
                                <i class="fas fa-utensils fa-3x"></i>
                            </div>
                            <h5>Recipe Suggestions</h5>
                            <p class="text-muted">Discover healthy recipes tailored to your dietary preferences and restrictions.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card h-100 text-center">
                        <div class="card-body">
                            <div class="text-warning mb-3">
                                <i class="fas fa-calendar-alt fa-3x"></i>
                            </div>
                            <h5>Meal Planning</h5>
                            <p class="text-muted">Learn how to plan balanced meals and organize your weekly nutrition.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="d-none">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
        <span>AI is thinking...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isWaitingForResponse = false;

function sendMessage() {
    const messageInput = document.getElementById('user-message');
    const message = messageInput.value.trim();
    
    if (!message || isWaitingForResponse) return;
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    messageInput.value = '';
    
    // Show loading
    showLoadingMessage();
    isWaitingForResponse = true;
    
    // Send to AI
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingMessage();
        isWaitingForResponse = false;
        
        if (data.status === 'success') {
            addMessageToChat(data.response, 'ai');
        } else {
            addMessageToChat('Sorry, I encountered an error: ' + data.message, 'ai', true);
        }
    })
    .catch(error => {
        hideLoadingMessage();
        isWaitingForResponse = false;
        addMessageToChat('Sorry, I encountered a technical error. Please try again.', 'ai', true);
        console.error('Chat error:', error);
    });
}

function addMessageToChat(message, sender, isError = false) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-bubble ' + (sender === 'user' ? 'user-message' : 'ai-message');
    
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex mb-3 justify-content-end">
                <div class="flex-grow-1 text-end">
                    <div class="message-content user-message-content d-inline-block" style="max-width: 80%;">
                        <p class="mb-0">${escapeHtml(message)}</p>
                    </div>
                    <small class="timestamp">${timestamp}</small>
                </div>
                <div class="ms-3">
                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-white" style="font-size: 14px;"></i>
                    </div>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex mb-3">
                <div class="me-3">
                    <div class="rounded-circle ${isError ? 'bg-danger' : 'bg-primary'} d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="fas fa-robot text-primary" style="font-size: 14px;"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="message-content">
                        <p class="mb-0">${formatMessage(message)}</p>
                    </div>
                    <small class="timestamp">${timestamp}</small>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoadingMessage() {
    const chatMessages = document.getElementById('chat-messages');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'message-bubble ai-message';
    loadingDiv.innerHTML = `
        <div class="d-flex mb-3">
            <div class="me-3">
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-robot text-white" style="font-size: 14px;"></i>
                </div>
            </div>
            <div class="flex-grow-1">
                <div class="bg-light p-3 rounded-3">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideLoadingMessage() {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
        loadingMessage.remove();
    }
}

function askQuickQuestion(question) {
    document.getElementById('user-message').value = question;
    sendMessage();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMessage(message) {
    // Convert newlines to <br> and format the message
    return escapeHtml(message).replace(/\n/g, '<br>');
}

// Allow Enter key to send message
document.getElementById('user-message').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-focus on message input
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('user-message').focus();
});
</script>

<style>
    .chat-container {
        background: rgba(248, 249, 250, 0.95);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .message-bubble {
        animation: fadeIn 0.3s ease-in;
        margin-bottom: 1rem;
    }

    .user-message-content {
        background: var(--gradient-primary);
        color: white;
        padding: 12px 16px;
        border-radius: var(--border-radius);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ai-message .message-content {
        background: rgba(255, 255, 255, 0.95);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .message-content {
        padding: 12px 16px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    .timestamp {
        color: var(--text-secondary);
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message .message-content {
    background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
    color: white !important;
    margin-left: auto;
    margin-right: 0;
    max-width: 80%;
}

.ai-message .message-content {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #1e293b !important;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    max-width: 80%;
}

.message-content {
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.message-content p, .message-content ul, .message-content li {
    color: inherit !important;
    margin-bottom: 0.5rem;
}

.message-content ul {
    padding-left: 1.2rem;
}

.user-message .bg-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
}

.user-message-content {
    background: var(--gradient-primary);
    color: white;
    padding: 12px 16px;
    border-radius: var(--border-radius);
}

.timestamp {
    color: var(--text-secondary);
    font-size: 0.75rem;
}
</style>
{% endblock %}
