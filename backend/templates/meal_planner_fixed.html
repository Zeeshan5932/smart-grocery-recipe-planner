{% extends "base.html" %}

{% block title %}Meal Planner - Smart Grocery + Recipe Planner{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="main-content">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-utensils me-3"></i>
                AI Meal Planner
            </h1>
            <p class="lead text-muted">Create personalized meal plans based on your health goals and preferences</p>
        </div>
        
        <!-- BMI Calculator Only -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="glass-card shadow-strong">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4 text-primary text-center">
                            <i class="fas fa-calculator me-2"></i>Calculate Your BMI
                        </h4>
                        <p class="text-muted mb-4 text-center">First, let's calculate your Body Mass Index to better understand your health profile.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Height (cm)</label>
                                    <input type="number" class="form-control" id="height" placeholder="170" min="100" max="250" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Weight (kg)</label>
                                    <input type="number" class="form-control" id="weight" placeholder="70" min="30" max="200" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-primary btn-lg" onclick="calculateBMI()">
                                <i class="fas fa-calculator me-2"></i>Calculate BMI
                            </button>
                        </div>
                        
                        <!-- BMI Result -->
                        <div id="bmi-result" class="alert alert-info d-none">
                            <div class="text-center">
                                <h5 class="mb-1">Your BMI: <span id="bmi-value" class="fw-bold"></span></h5>
                                <p class="mb-3">Category: <span id="bmi-category" class="fw-bold"></span></p>
                                <button type="button" class="btn btn-success btn-lg" onclick="proceedToMealPlan()">
                                    Continue to Meal Planning <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Instructions when BMI not calculated -->
                        <div id="bmi-instructions" class="text-center text-muted">
                            <p><i class="fas fa-info-circle me-2"></i>Enter your height and weight, then click "Calculate BMI" to proceed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meal Planning Section (Hidden Initially) -->
        <div id="meal-planning-section" class="row justify-content-center mt-5 d-none">
            <div class="col-lg-10">
                <div class="glass-card shadow-strong">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4 text-primary text-center">
                            <i class="fas fa-cutlery me-2"></i>Personalized Meal Plan
                        </h4>
                        
                        <!-- User Profile Summary -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="alert alert-light">
                                    <h6 class="mb-2"><i class="fas fa-user me-2"></i>Your Profile</h6>
                                    <p class="mb-1"><strong>BMI:</strong> <span id="profile-bmi"></span></p>
                                    <p class="mb-0"><strong>Category:</strong> <span id="profile-category"></span></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-light">
                                    <h6 class="mb-2"><i class="fas fa-target me-2"></i>Recommended Goal</h6>
                                    <p class="mb-0"><span id="health-goal"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Meal Plan Options -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-sun fa-2x text-warning mb-3"></i>
                                        <h6 class="card-title">Breakfast</h6>
                                        <div id="breakfast-suggestions">
                                            <p class="text-muted">Loading suggestions...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-sun fa-2x text-orange mb-3"></i>
                                        <h6 class="card-title">Lunch</h6>
                                        <div id="lunch-suggestions">
                                            <p class="text-muted">Loading suggestions...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-moon fa-2x text-primary mb-3"></i>
                                        <h6 class="card-title">Dinner</h6>
                                        <div id="dinner-suggestions">
                                            <p class="text-muted">Loading suggestions...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Features -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-shopping-cart me-2"></i>Shopping List</h6>
                                        <p class="card-text">Based on your meal plan</p>
                                        <button class="btn btn-success btn-sm" onclick="generateShoppingList()">
                                            Generate List
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-chart-line me-2"></i>Nutrition Tracker</h6>
                                        <p class="card-text">Track your daily nutrition</p>
                                        <button class="btn btn-info btn-sm" onclick="showNutritionTracker()">
                                            View Tracker
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Back to BMI Button -->
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-secondary" onclick="backToBMI()">
                                <i class="fas fa-arrow-left me-2"></i>Back to BMI Calculator
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let userBMI = null;
    let userBMICategory = '';
    
    // BMI Calculator Function
    function calculateBMI() {
        console.log('calculateBMI function called');
        
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        
        console.log('Height:', height, 'Weight:', weight);
        
        if (!height || !weight || height <= 0 || weight <= 0) {
            alert('Please enter valid height and weight values.');
            return;
        }
        
        // Calculate BMI
        const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
        userBMI = bmi;
        
        console.log('Calculated BMI:', bmi);
        
        // Determine BMI category
        let category = '';
        let categoryClass = '';
        
        if (bmi < 18.5) {
            category = 'Underweight';
            categoryClass = 'text-warning';
        } else if (bmi >= 18.5 && bmi < 25) {
            category = 'Normal weight';
            categoryClass = 'text-success';
        } else if (bmi >= 25 && bmi < 30) {
            category = 'Overweight';
            categoryClass = 'text-warning';
        } else {
            category = 'Obese';
            categoryClass = 'text-danger';
        }
        
        userBMICategory = category;
        console.log('BMI Category:', category);
        
        // Display BMI result
        const bmiValueElement = document.getElementById('bmi-value');
        const bmiCategoryElement = document.getElementById('bmi-category');
        const bmiInstructions = document.getElementById('bmi-instructions');
        const bmiResult = document.getElementById('bmi-result');
        
        if (bmiValueElement) bmiValueElement.textContent = bmi;
        if (bmiCategoryElement) {
            bmiCategoryElement.textContent = category;
            bmiCategoryElement.className = `fw-bold ${categoryClass}`;
        }
        
        // Hide instructions and show result
        if (bmiInstructions) bmiInstructions.classList.add('d-none');
        if (bmiResult) bmiResult.classList.remove('d-none');
        
        alert(`BMI calculated successfully! Your BMI is ${bmi} (${category})`);
    }
    
    // Function to proceed to meal planning
    function proceedToMealPlan() {
        if (userBMI) {
            // Hide BMI section and show meal planning section
            const mealPlanningSection = document.getElementById('meal-planning-section');
            if (mealPlanningSection) {
                mealPlanningSection.classList.remove('d-none');
                
                // Scroll to meal planning section
                mealPlanningSection.scrollIntoView({ behavior: 'smooth' });
                
                // Update profile information
                updateUserProfile();
                
                // Generate meal suggestions
                generateMealSuggestions();
            }
        } else {
            alert('Please calculate your BMI first!');
        }
    }
    
    // Update user profile in meal planning section
    function updateUserProfile() {
        const profileBMI = document.getElementById('profile-bmi');
        const profileCategory = document.getElementById('profile-category');
        const healthGoal = document.getElementById('health-goal');
        
        if (profileBMI) profileBMI.textContent = userBMI;
        if (profileCategory) profileCategory.textContent = userBMICategory;
        
        // Set health goal based on BMI category
        let goal = '';
        if (userBMICategory === 'Underweight') {
            goal = 'Focus on healthy weight gain with nutrient-rich foods';
        } else if (userBMICategory === 'Normal weight') {
            goal = 'Maintain current weight with balanced nutrition';
        } else if (userBMICategory === 'Overweight') {
            goal = 'Gradual weight loss with portion control';
        } else if (userBMICategory === 'Obese') {
            goal = 'Structured weight loss with professional guidance';
        }
        
        if (healthGoal) healthGoal.textContent = goal;
    }
    
    // Generate meal suggestions based on BMI category
    function generateMealSuggestions() {
        const breakfast = document.getElementById('breakfast-suggestions');
        const lunch = document.getElementById('lunch-suggestions');
        const dinner = document.getElementById('dinner-suggestions');
        
        let breakfastSuggestions, lunchSuggestions, dinnerSuggestions;
        
        if (userBMICategory === 'Underweight') {
            breakfastSuggestions = [
                '‚Ä¢ Oatmeal with nuts and fruits',
                '‚Ä¢ Whole grain toast with avocado',
                '‚Ä¢ Protein smoothie with banana'
            ];
            lunchSuggestions = [
                '‚Ä¢ Quinoa bowl with grilled chicken',
                '‚Ä¢ Pasta with lean meat sauce',
                '‚Ä¢ Rice with lentils and vegetables'
            ];
            dinnerSuggestions = [
                '‚Ä¢ Salmon with sweet potato',
                '‚Ä¢ Chicken curry with brown rice',
                '‚Ä¢ Lean beef with quinoa'
            ];
        } else if (userBMICategory === 'Normal weight') {
            breakfastSuggestions = [
                '‚Ä¢ Greek yogurt with berries',
                '‚Ä¢ Eggs with whole grain toast',
                '‚Ä¢ Smoothie bowl with granola'
            ];
            lunchSuggestions = [
                '‚Ä¢ Grilled chicken salad',
                '‚Ä¢ Quinoa and vegetable bowl',
                '‚Ä¢ Turkey and avocado wrap'
            ];
            dinnerSuggestions = [
                '‚Ä¢ Baked fish with vegetables',
                '‚Ä¢ Lean meat with brown rice',
                '‚Ä¢ Tofu stir-fry with quinoa'
            ];
        } else if (userBMICategory === 'Overweight' || userBMICategory === 'Obese') {
            breakfastSuggestions = [
                '‚Ä¢ Vegetable omelet (2 eggs)',
                '‚Ä¢ Greek yogurt with berries',
                '‚Ä¢ Green smoothie with protein'
            ];
            lunchSuggestions = [
                '‚Ä¢ Large mixed green salad',
                '‚Ä¢ Grilled chicken with vegetables',
                '‚Ä¢ Lentil soup with side salad'
            ];
            dinnerSuggestions = [
                '‚Ä¢ Steamed fish with broccoli',
                '‚Ä¢ Grilled chicken breast',
                '‚Ä¢ Vegetable curry with cauliflower rice'
            ];
        }
        
        if (breakfast) breakfast.innerHTML = breakfastSuggestions.join('<br>');
        if (lunch) lunch.innerHTML = lunchSuggestions.join('<br>');
        if (dinner) dinner.innerHTML = dinnerSuggestions.join('<br>');
    }
    
    // Generate shopping list and PDF
    function generateShoppingList() {
        let shoppingItems = [];
        let mealSuggestions = {};
        
        if (userBMICategory === 'Underweight') {
            shoppingItems = [
                'Oats', 'Mixed nuts', 'Bananas', 'Avocados', 'Whole grain bread',
                'Quinoa', 'Chicken breast', 'Pasta', 'Lean ground meat',
                'Salmon', 'Sweet potatoes', 'Brown rice', 'Lentils'
            ];
            mealSuggestions = {
                breakfast: ['Oatmeal with nuts and fruits', 'Whole grain toast with avocado', 'Protein smoothie with banana'],
                lunch: ['Quinoa bowl with grilled chicken', 'Pasta with lean meat sauce', 'Rice with lentils and vegetables'],
                dinner: ['Salmon with sweet potato', 'Chicken curry with brown rice', 'Lean beef with quinoa']
            };
        } else if (userBMICategory === 'Normal weight') {
            shoppingItems = [
                'Greek yogurt', 'Mixed berries', 'Eggs', 'Whole grain bread',
                'Quinoa', 'Mixed vegetables', 'Turkey slices', 'Fish fillets',
                'Brown rice', 'Tofu', 'Lean meat'
            ];
            mealSuggestions = {
                breakfast: ['Greek yogurt with berries', 'Eggs with whole grain toast', 'Smoothie bowl with granola'],
                lunch: ['Grilled chicken salad', 'Quinoa and vegetable bowl', 'Turkey and avocado wrap'],
                dinner: ['Baked fish with vegetables', 'Lean meat with brown rice', 'Tofu stir-fry with quinoa']
            };
        } else {
            shoppingItems = [
                'Eggs', 'Greek yogurt', 'Mixed berries', 'Leafy greens',
                'Chicken breast', 'Mixed vegetables', 'Lentils', 'Fish fillets',
                'Broccoli', 'Cauliflower', 'Bell peppers', 'Cucumber'
            ];
            mealSuggestions = {
                breakfast: ['Vegetable omelet (2 eggs)', 'Greek yogurt with berries', 'Green smoothie with protein'],
                lunch: ['Large mixed green salad', 'Grilled chicken with vegetables', 'Lentil soup with side salad'],
                dinner: ['Steamed fish with broccoli', 'Grilled chicken breast', 'Vegetable curry with cauliflower rice']
            };
        }
        
        // Generate PDF
        generatePDF(shoppingItems, mealSuggestions);
    }
    
    // Generate and download PDF
    function generatePDF(shoppingItems, mealSuggestions) {
        const healthGoal = getHealthGoal();
        
        const pdfContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="color: #0066cc; margin-bottom: 10px;">Smart Grocery + Recipe Planner</h1>
                    <h2 style="color: #333; margin-bottom: 5px;">Personalized Shopping List & Meal Plan</h2>
                    <p style="color: #666; margin: 0;">Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: #0066cc; margin-top: 0;">Your Health Profile</h3>
                    <p><strong>BMI:</strong> ${userBMI}</p>
                    <p><strong>Category:</strong> ${userBMICategory}</p>
                    <p style="margin-bottom: 0;"><strong>Health Goal:</strong> ${healthGoal}</p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 5px;">Shopping List</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                        ${shoppingItems.map(item => `<div style="padding: 8px; background-color: #f8f9fa; border-radius: 4px;">‚Ä¢ ${item}</div>`).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 5px;">Recommended Meal Plan</h3>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #ff9500; margin-bottom: 10px;">üåÖ Breakfast Options</h4>
                        ${mealSuggestions.breakfast.map(meal => `<p style="margin: 5px 0; padding-left: 15px;">‚Ä¢ ${meal}</p>`).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #ff6500; margin-bottom: 10px;">‚òÄÔ∏è Lunch Options</h4>
                        ${mealSuggestions.lunch.map(meal => `<p style="margin: 5px 0; padding-left: 15px;">‚Ä¢ ${meal}</p>`).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #0066cc; margin-bottom: 10px;">üåô Dinner Options</h4>
                        ${mealSuggestions.dinner.map(meal => `<p style="margin: 5px 0; padding-left: 15px;">‚Ä¢ ${meal}</p>`).join('')}
                    </div>
                </div>
                
                <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 25px;">
                    <h4 style="color: #0066cc; margin-top: 0;">üí° Tips for Success</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Plan your meals in advance</li>
                        <li>Buy fresh ingredients and prepare meals in batches</li>
                        <li>Stay hydrated - drink plenty of water</li>
                        <li>Include variety in your meals for balanced nutrition</li>
                        <li>Track your progress and adjust as needed</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 12px;">Generated by Smart Grocery + Recipe Planner</p>
                </div>
            </div>
        `;
        
        // Create new window with PDF content
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Shopping List & Meal Plan - BMI ${userBMI}</title>
                <style>
                    body { margin: 0; }
                    @media print {
                        body { print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body>
                ${pdfContent}
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
        
        // Show success message
        setTimeout(() => {
            alert('Shopping list PDF generated! Check your Downloads folder or print dialog.');
        }, 500);
    }
    
    // Get health goal text
    function getHealthGoal() {
        if (userBMICategory === 'Underweight') {
            return 'Focus on healthy weight gain with nutrient-rich foods';
        } else if (userBMICategory === 'Normal weight') {
            return 'Maintain current weight with balanced nutrition';
        } else if (userBMICategory === 'Overweight') {
            return 'Gradual weight loss with portion control';
        } else if (userBMICategory === 'Obese') {
            return 'Structured weight loss with professional guidance';
        }
        return '';
    }
    
    // Show nutrition tracker
    function showNutritionTracker() {
        let dailyTargets = '';
        
        if (userBMICategory === 'Underweight') {
            dailyTargets = 'Calories: 2200-2500\nProtein: 1.2-1.6g per kg body weight\nCarbs: 45-65% of total calories\nFats: 20-35% of total calories';
        } else if (userBMICategory === 'Normal weight') {
            dailyTargets = 'Calories: 1800-2200\nProtein: 1.0-1.2g per kg body weight\nCarbs: 45-65% of total calories\nFats: 20-35% of total calories';
        } else {
            dailyTargets = 'Calories: 1200-1800\nProtein: 1.2-1.5g per kg body weight\nCarbs: 40-50% of total calories\nFats: 20-30% of total calories';
        }
        
        alert(`Daily Nutrition Targets:\n\n${dailyTargets}\n\nTip: Track your meals to stay within these ranges!`);
    }
    
    // Back to BMI calculator
    function backToBMI() {
        const mealPlanningSection = document.getElementById('meal-planning-section');
        if (mealPlanningSection) {
            mealPlanningSection.classList.add('d-none');
            
            // Scroll back to BMI section
            const bmiSection = document.querySelector('.glass-card');
            if (bmiSection) {
                bmiSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        const bmiInstructions = document.getElementById('bmi-instructions');
        const bmiResult = document.getElementById('bmi-result');
        
        if (bmiInstructions) bmiInstructions.classList.remove('d-none');
        if (bmiResult) bmiResult.classList.add('d-none');
    });
</script>
{% endblock %}
